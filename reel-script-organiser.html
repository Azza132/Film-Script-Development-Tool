<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>REEL â€” Film Script Organiser</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=Barlow+Condensed:wght@300;400;500;600;700&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VARIABLES & RESET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:        #0c0b0a;
  --s1:        #141311;
  --s2:        #1c1a17;
  --s3:        #242118;
  --border:    #2e2b24;
  --border2:   #3d3930;
  --gold:      #c9a84c;
  --gold2:     #e8c96a;
  --gold-dim:  #7a6530;
  --red:       #c44a3a;
  --blue:      #4a7fa8;
  --green:     #5a9a6a;
  --text:      #ede8dc;
  --text2:     #a09880;
  --text3:     #6a6050;
  --card:      #f5f0e4;
  --card-line: #d4cdb8;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Barlow', sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-size: 13px;
}
button { cursor: pointer; }
input, textarea { font-family: inherit; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TITLEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#titlebar {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  height: 48px;
  display: flex;
  align-items: center;
  padding: 0 16px;
  gap: 16px;
  flex-shrink: 0;
  position: relative;
}
.logo-mark {
  font-family: 'Barlow Condensed', sans-serif;
  font-weight: 700;
  font-size: 20px;
  letter-spacing: 6px;
  color: var(--gold);
  text-transform: uppercase;
}
.logo-sub {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 3px;
  color: var(--text3);
  text-transform: uppercase;
  margin-top: -2px;
}
.project-title-wrap {
  flex: 1;
  display: flex;
  justify-content: center;
}
#projectTitleInput {
  background: transparent;
  border: none;
  border-bottom: 1px solid transparent;
  color: var(--text);
  font-family: 'DM Serif Display', serif;
  font-size: 16px;
  text-align: center;
  outline: none;
  padding: 2px 12px;
  min-width: 200px;
  transition: border-color 0.2s;
}
#projectTitleInput:hover, #projectTitleInput:focus {
  border-bottom-color: var(--gold-dim);
}
.tb-right { display: flex; gap: 8px; }
.tb-btn {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text3);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 1.5px;
  padding: 5px 12px;
  text-transform: uppercase;
  transition: all 0.2s;
}
.tb-btn:hover { border-color: var(--gold); color: var(--gold); }
.tb-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }
.by-line {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 1px;
  color: var(--text3);
  white-space: nowrap;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: stretch;
  height: 36px;
  flex-shrink: 0;
  gap: 0;
}
.nav-tab {
  background: transparent;
  border: none;
  border-right: 1px solid var(--border);
  border-bottom: 2px solid transparent;
  color: var(--text3);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  padding: 0 18px;
  text-transform: uppercase;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.nav-tab:hover { color: var(--text2); background: var(--s2); }
.nav-tab.active { color: var(--gold); border-bottom-color: var(--gold); background: var(--s2); }
.nav-tab .icon { font-size: 13px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app {
  display: flex;
  flex: 1;
  overflow: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BINDER (left sidebar)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#binder {
  width: 220px;
  background: var(--s1);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
  overflow: hidden;
}
.binder-header {
  padding: 10px 12px 6px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.binder-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
}
.binder-add {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--gold-dim);
  font-size: 16px;
  width: 22px;
  height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  line-height: 1;
}
.binder-add:hover { border-color: var(--gold); color: var(--gold); }
#binderTree {
  flex: 1;
  overflow-y: auto;
  padding: 6px 0;
}
/* Tree nodes */
.tree-group { margin-bottom: 2px; }
.tree-group-header {
  display: flex;
  align-items: center;
  padding: 5px 10px 5px 8px;
  gap: 5px;
  cursor: pointer;
  border-left: 2px solid transparent;
  transition: all 0.15s;
  user-select: none;
}
.tree-group-header:hover { background: var(--s2); }
.tree-group-header.active-group { border-left-color: var(--gold); background: var(--s2); }
.tree-chevron { 
  color: var(--text3); font-size: 9px; width: 10px; flex-shrink: 0;
  transition: transform 0.2s;
}
.tree-chevron.open { transform: rotate(90deg); }
.tree-group-icon { font-size: 12px; flex-shrink: 0; }
.tree-group-label {
  flex: 1;
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 12px;
  letter-spacing: 1px;
  color: var(--text2);
  text-transform: uppercase;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.tree-group-header .tree-del {
  display: none;
  background: transparent;
  border: none;
  color: var(--red);
  font-size: 11px;
  padding: 0 2px;
}
.tree-group-header:hover .tree-del { display: block; }

.tree-children { padding-left: 16px; display: none; }
.tree-children.open { display: block; }
.tree-item {
  display: flex;
  align-items: center;
  padding: 4px 10px 4px 6px;
  gap: 5px;
  cursor: pointer;
  border-left: 2px solid transparent;
  transition: all 0.15s;
}
.tree-item:hover { background: var(--s2); }
.tree-item.active { border-left-color: var(--gold2); background: var(--s3); }
.tree-item-icon { font-size: 11px; color: var(--text3); flex-shrink: 0; }
.tree-item-label {
  flex: 1;
  font-size: 12px;
  color: var(--text2);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.tree-item.active .tree-item-label { color: var(--text); }
.tree-item .tree-del {
  display: none;
  background: transparent;
  border: none;
  color: var(--red);
  font-size: 10px;
  padding: 0 2px;
}
.tree-item:hover .tree-del { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN CONTENT AREA (views)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#main {
  flex: 1;
  display: flex;
  overflow: hidden;
  position: relative;
}

.view { display: none; flex: 1; overflow: hidden; }
.view.active { display: flex; }

/* â”€â”€â”€ EDITOR VIEW â”€â”€â”€ */
#editorView {
  flex-direction: row;
}
#editorPane {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--s2);
}
.editor-topbar {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
#docTitleInput {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
  outline: none;
  flex: 1;
  padding: 2px 6px;
}
#docTitleInput:focus { border-bottom-color: var(--gold-dim); }
.doc-type-badge {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 3px 8px;
  border: 1px solid;
  border-radius: 0;
}
.badge-scene { border-color: var(--gold-dim); color: var(--gold-dim); }
.badge-character { border-color: var(--blue); color: var(--blue); }
.badge-research { border-color: var(--green); color: var(--green); }
.badge-note { border-color: var(--text3); color: var(--text3); }

#docEditor {
  flex: 1;
  background: var(--s2);
  color: var(--text);
  border: none;
  outline: none;
  padding: 30px 40px;
  font-family: 'Barlow', sans-serif;
  font-size: 13px;
  line-height: 1.8;
  resize: none;
  overflow-y: auto;
}
#docEditor::placeholder { color: var(--text3); }

.editor-footer {
  background: var(--s1);
  border-top: 1px solid var(--border);
  padding: 5px 16px;
  display: flex;
  gap: 20px;
  flex-shrink: 0;
}
.footer-stat {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 1px;
  color: var(--text3);
}
.footer-stat span { color: var(--text2); }

/* Inspector pane */
#inspectorPane {
  width: 240px;
  background: var(--s1);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  flex-shrink: 0;
}
.insp-section {
  border-bottom: 1px solid var(--border);
  padding: 12px;
}
.insp-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 8px;
}
.insp-synopsis {
  width: 100%;
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 12px;
  line-height: 1.6;
  padding: 8px;
  resize: none;
  height: 100px;
  outline: none;
}
.insp-synopsis:focus { border-color: var(--gold-dim); }
.meta-row {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 2px;
}
.meta-field { display: flex; flex-direction: column; gap: 3px; }
.meta-label {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text3);
}
.meta-input, .meta-select {
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text);
  font-size: 11px;
  padding: 5px 8px;
  outline: none;
  font-family: 'Barlow', sans-serif;
  width: 100%;
}
.meta-input:focus, .meta-select:focus { border-color: var(--gold-dim); }
.meta-select option { background: var(--s2); }
.color-chips { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 2px; }
.color-chip {
  width: 18px; height: 18px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: transform 0.1s;
}
.color-chip:hover { transform: scale(1.15); }
.color-chip.selected { border-color: var(--text); }

/* â”€â”€â”€ CORKBOARD VIEW â”€â”€â”€ */
#corkView {
  flex-direction: column;
  background: #2a1f14;
  overflow: hidden;
}
.cork-toolbar {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-shrink: 0;
}
.cork-toolbar-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
  margin-right: 8px;
}
.cork-filter {
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text2);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  padding: 4px 10px;
  cursor: pointer;
  letter-spacing: 1px;
  transition: all 0.15s;
}
.cork-filter:hover, .cork-filter.active { border-color: var(--gold); color: var(--gold); }
.cork-spacer { flex: 1; }
.cork-add {
  background: rgba(201,168,76,0.1);
  border: 1px solid var(--gold-dim);
  color: var(--gold);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 1.5px;
  padding: 5px 14px;
  text-transform: uppercase;
  transition: all 0.2s;
}
.cork-add:hover { background: rgba(201,168,76,0.2); }

#corkBoard {
  flex: 1;
  overflow-y: auto;
  padding: 30px;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-content: flex-start;
  background-image: 
    radial-gradient(circle at 1px 1px, rgba(255,255,255,0.03) 1px, transparent 0);
  background-size: 24px 24px;
}
.index-card {
  width: 200px;
  min-height: 160px;
  background: var(--card);
  box-shadow: 3px 4px 12px rgba(0,0,0,0.5), 0 0 0 1px rgba(0,0,0,0.2);
  display: flex;
  flex-direction: column;
  cursor: pointer;
  transition: transform 0.15s, box-shadow 0.15s;
  position: relative;
  animation: cardIn 0.25s ease both;
}
@keyframes cardIn {
  from { opacity: 0; transform: translateY(8px) scale(0.97); }
  to { opacity: 1; transform: none; }
}
.index-card:hover {
  transform: translateY(-3px) rotate(0.5deg);
  box-shadow: 5px 8px 20px rgba(0,0,0,0.6);
}
.card-stripe {
  height: 8px;
  flex-shrink: 0;
}
.card-body {
  padding: 10px 12px;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.card-number {
  font-family: 'DM Mono', monospace;
  font-size: 9px;
  color: #999;
  letter-spacing: 1px;
}
.card-title {
  font-family: 'DM Serif Display', serif;
  font-size: 13px;
  color: #1a1a1a;
  line-height: 1.3;
  font-weight: 400;
}
.card-synopsis {
  font-size: 11px;
  color: #555;
  line-height: 1.5;
  flex: 1;
}
.card-footer {
  padding: 6px 12px;
  border-top: 1px solid var(--card-line);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.card-tag {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: #888;
}
.card-words { font-size: 9px; color: #aaa; font-family: 'DM Mono', monospace; }
.card-del {
  position: absolute;
  top: 12px;
  right: 8px;
  background: rgba(0,0,0,0.1);
  border: none;
  color: #999;
  font-size: 12px;
  width: 18px;
  height: 18px;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}
.index-card:hover .card-del { display: flex; }

/* â”€â”€â”€ BEAT BOARD VIEW â”€â”€â”€ */
#beatView {
  flex-direction: column;
  overflow: hidden;
}
.beat-toolbar {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-shrink: 0;
}
.beat-toolbar-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
  flex: 1;
}
.beat-template-select {
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text2);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  padding: 4px 10px;
  outline: none;
}
#beatBoard {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.beat-structure {
  display: grid;
  gap: 10px;
}
.beat-item {
  background: var(--s2);
  border: 1px solid var(--border);
  border-left: 4px solid;
  display: flex;
  gap: 0;
  min-height: 60px;
  transition: border-color 0.2s;
}
.beat-item:hover { border-color: var(--border2); }
.beat-left {
  width: 160px;
  padding: 10px 12px;
  border-right: 1px solid var(--border);
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.beat-name {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 1px;
  text-transform: uppercase;
  color: var(--text2);
  line-height: 1.3;
}
.beat-pct {
  font-family: 'DM Mono', monospace;
  font-size: 9px;
  color: var(--text3);
  margin-top: 2px;
}
.beat-right {
  flex: 1;
  padding: 8px 12px;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.beat-textarea {
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 12px;
  line-height: 1.6;
  resize: none;
  outline: none;
  font-family: 'Barlow', sans-serif;
  flex: 1;
  min-height: 44px;
}
.beat-textarea::placeholder { color: var(--text3); font-style: italic; }
.beat-scene-link {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 1px;
  color: var(--text3);
  text-transform: uppercase;
}

/* â”€â”€â”€ CHARACTERS VIEW â”€â”€â”€ */
#charView {
  flex-direction: column;
  overflow: hidden;
}
.char-toolbar {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  gap: 10px;
  align-items: center;
  flex-shrink: 0;
}
.char-toolbar-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
  flex: 1;
}
#charGrid {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-content: flex-start;
}
.char-card {
  width: 240px;
  background: var(--s2);
  border: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.2s;
  animation: cardIn 0.2s ease both;
}
.char-card:hover { border-color: var(--gold-dim); transform: translateY(-2px); }
.char-card-head {
  padding: 14px 14px 10px;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.char-initial {
  font-family: 'DM Serif Display', serif;
  font-size: 36px;
  line-height: 1;
  color: var(--gold-dim);
  margin-bottom: 4px;
}
.char-card-name {
  font-family: 'DM Serif Display', serif;
  font-size: 16px;
  color: var(--text);
  margin-bottom: 2px;
}
.char-role-badge {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
}
.char-card-body { padding: 10px 14px 14px; }
.char-field { margin-bottom: 8px; }
.char-field-label {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 9px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 3px;
}
.char-field-val {
  font-size: 11px;
  color: var(--text2);
  line-height: 1.5;
}
.char-card-del {
  position: absolute;
  top: 10px; right: 10px;
  background: transparent;
  border: 1px solid var(--border);
  color: var(--red);
  font-size: 10px;
  padding: 2px 6px;
  display: none;
}
.char-card:hover .char-card-del { display: block; }

/* Character editor modal */
.modal-bg {
  display: none;
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 200;
  justify-content: center;
  align-items: center;
}
.modal-bg.open { display: flex; }
.modal-box {
  background: var(--s1);
  border: 1px solid var(--border2);
  width: 560px;
  max-height: 85vh;
  overflow-y: auto;
  animation: modalIn 0.2s ease both;
}
@keyframes modalIn {
  from { opacity:0; transform: scale(0.96) translateY(-10px); }
  to { opacity:1; transform: none; }
}
.modal-header {
  background: var(--bg);
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-header h2 {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 14px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--gold);
}
.modal-close {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text3);
  font-size: 14px;
  width: 28px; height: 28px;
  transition: all 0.15s;
}
.modal-close:hover { border-color: var(--red); color: var(--red); }
.modal-body { padding: 18px; }
.modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.modal-field { display: flex; flex-direction: column; gap: 4px; }
.modal-field.full { grid-column: 1/-1; }
.modal-label {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 1.5px;
  text-transform: uppercase;
  color: var(--text3);
}
.modal-input, .modal-textarea, .modal-select {
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'Barlow', sans-serif;
  font-size: 12px;
  padding: 7px 10px;
  outline: none;
  transition: border-color 0.2s;
}
.modal-input:focus, .modal-textarea:focus { border-color: var(--gold-dim); }
.modal-textarea { resize: none; height: 80px; }
.modal-footer {
  padding: 12px 18px;
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}
.btn-cancel {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text3);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 1px;
  padding: 7px 16px;
  text-transform: uppercase;
  transition: all 0.2s;
}
.btn-cancel:hover { border-color: var(--text3); color: var(--text2); }
.btn-save {
  background: rgba(201,168,76,0.1);
  border: 1px solid var(--gold);
  color: var(--gold);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 1.5px;
  padding: 7px 20px;
  text-transform: uppercase;
  transition: all 0.2s;
}
.btn-save:hover { background: rgba(201,168,76,0.25); }

/* â”€â”€â”€ LOGLINE / SYNOPSIS VIEW â”€â”€â”€ */
#loglineView {
  flex-direction: column;
  overflow: hidden;
}
#loglineArea {
  flex: 1;
  overflow-y: auto;
  padding: 40px;
  max-width: 860px;
  margin: 0 auto;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 32px;
}
.logline-section { display: flex; flex-direction: column; gap: 10px; }
.logline-section-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--gold-dim);
  border-bottom: 1px solid var(--border);
  padding-bottom: 6px;
}
.logline-input {
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'DM Serif Display', serif;
  font-size: 17px;
  line-height: 1.6;
  padding: 14px 18px;
  resize: none;
  outline: none;
  width: 100%;
  transition: border-color 0.2s;
}
.logline-input:focus { border-color: var(--gold-dim); }
.logline-input.small {
  font-family: 'Barlow', sans-serif;
  font-size: 13px;
  height: 120px;
}
.logline-input.large { height: 200px; font-size: 14px; font-family: 'Barlow', sans-serif; }
.logline-hint { font-size: 11px; color: var(--text3); line-height: 1.6; font-style: italic; }

.genre-pills { display: flex; flex-wrap: wrap; gap: 6px; }
.genre-pill {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text3);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 1px;
  padding: 4px 12px;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.15s;
}
.genre-pill:hover { border-color: var(--text3); color: var(--text2); }
.genre-pill.selected { border-color: var(--gold); color: var(--gold); background: rgba(201,168,76,0.08); }

.theme-textarea {
  background: var(--s2);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'Barlow', sans-serif;
  font-size: 12px;
  line-height: 1.7;
  padding: 10px 14px;
  resize: none;
  outline: none;
  height: 80px;
  width: 100%;
}
.theme-textarea:focus { border-color: var(--gold-dim); }

/* â”€â”€â”€ RESEARCH VIEW â”€â”€â”€ */
#researchView {
  flex-direction: row;
}
#researchSidebar {
  width: 220px;
  background: var(--s1);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}
.research-list-header {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.research-list-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
}
#researchList {
  flex: 1;
  overflow-y: auto;
  padding: 6px 0;
}
.research-item {
  padding: 7px 12px;
  cursor: pointer;
  border-left: 2px solid transparent;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 7px;
}
.research-item:hover { background: var(--s2); }
.research-item.active { border-left-color: var(--gold); background: var(--s2); }
.research-item-icon { font-size: 12px; color: var(--text3); }
.research-item-name { font-size: 12px; color: var(--text2); flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.research-item.active .research-item-name { color: var(--text); }
.research-item-del {
  display: none;
  background: transparent;
  border: none;
  color: var(--red);
  font-size: 10px;
}
.research-item:hover .research-item-del { display: block; }
#researchMain {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.research-entry-header {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  flex-shrink: 0;
  display: flex;
  gap: 10px;
  align-items: center;
}
#researchTitleInput {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--border);
  color: var(--text);
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
  outline: none;
  flex: 1;
  padding: 2px 6px;
}
#researchTitleInput:focus { border-bottom-color: var(--gold-dim); }
#researchEditor {
  flex: 1;
  background: var(--s2);
  border: none;
  color: var(--text);
  font-family: 'Barlow', sans-serif;
  font-size: 13px;
  line-height: 1.8;
  padding: 30px 40px;
  resize: none;
  outline: none;
  overflow-y: auto;
}
#researchEditor::placeholder { color: var(--text3); }

/* â”€â”€â”€ TIMELINE VIEW â”€â”€â”€ */
#timelineView {
  flex-direction: column;
  overflow: hidden;
}
.timeline-toolbar {
  background: var(--s1);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.timeline-toolbar-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  color: var(--text3);
  text-transform: uppercase;
  flex: 1;
}
#timelineArea {
  flex: 1;
  overflow-x: auto;
  overflow-y: auto;
  padding: 24px;
}
.timeline-acts {
  display: flex;
  gap: 12px;
  min-width: max-content;
}
.timeline-act {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.act-header {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 10px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--gold-dim);
  border-bottom: 1px solid var(--gold-dim);
  padding-bottom: 6px;
  text-align: center;
}
.act-scenes { display: flex; flex-direction: column; gap: 6px; min-height: 100px; }
.tl-scene {
  width: 160px;
  background: var(--s2);
  border: 1px solid var(--border);
  border-left: 3px solid;
  padding: 8px 10px;
  cursor: pointer;
  transition: all 0.15s;
}
.tl-scene:hover { background: var(--s3); }
.tl-scene-title { font-size: 11px; color: var(--text); margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.tl-scene-loc { font-size: 10px; color: var(--text3); font-family: 'DM Mono', monospace; }

/* â”€â”€â”€ EMPTY STATES â”€â”€â”€ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 12px;
  color: var(--text3);
}
.empty-icon { font-size: 40px; opacity: 0.4; }
.empty-title {
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 14px;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text3);
}
.empty-sub { font-size: 12px; color: var(--text3); text-align: center; max-width: 260px; line-height: 1.6; }

/* â”€â”€â”€ TOAST â”€â”€â”€ */
#toast {
  position: fixed;
  bottom: 20px; left: 50%; transform: translateX(-50%);
  background: var(--s1);
  border: 1px solid var(--gold-dim);
  color: var(--gold);
  font-family: 'Barlow Condensed', sans-serif;
  font-size: 11px;
  letter-spacing: 2px;
  text-transform: uppercase;
  padding: 8px 20px;
  z-index: 300;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}
#toast.show { opacity: 1; }

/* â”€â”€â”€ CONTEXT MENU â”€â”€â”€ */
#ctxMenu {
  position: fixed;
  background: var(--s1);
  border: 1px solid var(--border2);
  min-width: 160px;
  z-index: 400;
  display: none;
  box-shadow: 4px 4px 20px rgba(0,0,0,0.5);
}
.ctx-item {
  padding: 8px 14px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  transition: background 0.1s;
  border-bottom: 1px solid var(--border);
}
.ctx-item:last-child { border-bottom: none; }
.ctx-item:hover { background: var(--s2); color: var(--text); }
.ctx-item.danger { color: var(--red); }

/* â”€â”€â”€ NEW SCENE MODAL â”€â”€â”€ */
#newSceneModal .modal-box { width: 460px; }
</style>
</head>
<body>

<!-- TITLEBAR -->
<div id="titlebar">
  <div>
    <div class="logo-mark">REEL</div>
    <div class="logo-sub">Script Organiser</div>
  </div>
  <div class="project-title-wrap">
    <input id="projectTitleInput" type="text" placeholder="Untitled Project" value="Untitled Project" />
  </div>
  <div class="tb-right">
    <button class="tb-btn" onclick="saveAll()">ğŸ’¾ Save</button>
    <button class="tb-btn" onclick="exportData()">Export</button>
    <button class="tb-btn" onclick="importData()">Import</button>
  </div>
  <div class="by-line">by Aaron Sermon</div>
</div>

<!-- NAV TABS -->
<div id="nav">
  <button class="nav-tab active" data-view="editorView" onclick="switchView('editorView',this)">
    <span class="icon">âœ</span> Binder
  </button>
  <button class="nav-tab" data-view="corkView" onclick="switchView('corkView',this)">
    <span class="icon">ğŸ“Œ</span> Corkboard
  </button>
  <button class="nav-tab" data-view="beatView" onclick="switchView('beatView',this)">
    <span class="icon">ğŸ¯</span> Beat Sheet
  </button>
  <button class="nav-tab" data-view="charView" onclick="switchView('charView',this)">
    <span class="icon">ğŸ‘¤</span> Characters
  </button>
  <button class="nav-tab" data-view="loglineView" onclick="switchView('loglineView',this)">
    <span class="icon">ğŸ“‹</span> Synopsis
  </button>
  <button class="nav-tab" data-view="researchView" onclick="switchView('researchView',this)">
    <span class="icon">ğŸ”</span> Research
  </button>
  <button class="nav-tab" data-view="timelineView" onclick="switchView('timelineView',this)">
    <span class="icon">ğŸ¬</span> Timeline
  </button>
</div>

<!-- APP BODY -->
<div id="app">

  <!-- â•â•â•â•â•â•â•â•â•â• BINDER / EDITOR VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view active" id="editorView">
    <!-- Binder sidebar -->
    <div id="binder">
      <div class="binder-header">
        <span class="binder-title">Project Binder</span>
        <button class="binder-add" onclick="showNewSceneModal()" title="New scene">+</button>
      </div>
      <div id="binderTree"></div>
    </div>
    <!-- Editor -->
    <div id="editorPane">
      <div class="editor-topbar">
        <input id="docTitleInput" type="text" placeholder="Document title..." oninput="onDocTitleChange()" />
        <div class="doc-type-badge badge-scene" id="docTypeBadge">SCENE</div>
      </div>
      <textarea id="docEditor" placeholder="Start writing hereâ€¦&#10;&#10;Use this space for scene notes, action lines, dialogue drafts, character descriptions, or any freeform content. Everything is saved automatically." oninput="onDocContentChange()"></textarea>
      <div class="editor-footer">
        <div class="footer-stat">Words: <span id="footerWords">0</span></div>
        <div class="footer-stat">Characters: <span id="footerChars">0</span></div>
        <div class="footer-stat">Last saved: <span id="footerSaved">â€”</span></div>
      </div>
    </div>
    <!-- Inspector -->
    <div id="inspectorPane">
      <div class="insp-section">
        <div class="insp-title">Synopsis</div>
        <textarea class="insp-synopsis" id="inspSynopsis" placeholder="Brief summary of this sceneâ€¦" oninput="onInspChange('synopsis', this.value)"></textarea>
      </div>
      <div class="insp-section">
        <div class="insp-title">Scene Meta</div>
        <div class="meta-row">
          <div class="meta-field">
            <div class="meta-label">Location</div>
            <input class="meta-input" id="metaLocation" placeholder="e.g. INT. KITCHEN" oninput="onInspChange('location', this.value)" />
          </div>
          <div class="meta-field">
            <div class="meta-label">Time of Day</div>
            <select class="meta-select" id="metaTime" onchange="onInspChange('time', this.value)">
              <option value="">â€”</option>
              <option>DAY</option><option>NIGHT</option><option>DAWN</option>
              <option>DUSK</option><option>CONTINUOUS</option><option>LATER</option>
            </select>
          </div>
          <div class="meta-field">
            <div class="meta-label">Int / Ext</div>
            <select class="meta-select" id="metaIntExt" onchange="onInspChange('intExt', this.value)">
              <option value="">â€”</option>
              <option>INT.</option><option>EXT.</option><option>INT./EXT.</option>
            </select>
          </div>
          <div class="meta-field">
            <div class="meta-label">Status</div>
            <select class="meta-select" id="metaStatus" onchange="onInspChange('status', this.value)">
              <option>Draft</option><option>In Progress</option><option>Complete</option><option>Needs Revision</option>
            </select>
          </div>
        </div>
      </div>
      <div class="insp-section">
        <div class="insp-title">Label Colour</div>
        <div class="color-chips" id="colorChips">
          <div class="color-chip" style="background:#c9a84c" data-color="#c9a84c" onclick="setColor('#c9a84c')"></div>
          <div class="color-chip" style="background:#c44a3a" data-color="#c44a3a" onclick="setColor('#c44a3a')"></div>
          <div class="color-chip" style="background:#4a7fa8" data-color="#4a7fa8" onclick="setColor('#4a7fa8')"></div>
          <div class="color-chip" style="background:#5a9a6a" data-color="#5a9a6a" onclick="setColor('#5a9a6a')"></div>
          <div class="color-chip" style="background:#8a5a9a" data-color="#8a5a9a" onclick="setColor('#8a5a9a')"></div>
          <div class="color-chip" style="background:#9a7a5a" data-color="#9a7a5a" onclick="setColor('#9a7a5a')"></div>
          <div class="color-chip" style="background:#4a8a8a" data-color="#4a8a8a" onclick="setColor('#4a8a8a')"></div>
          <div class="color-chip" style="background:#555" data-color="#555" onclick="setColor('#555')"></div>
        </div>
      </div>
      <div class="insp-section" style="flex:1">
        <div class="insp-title">Scene Notes</div>
        <textarea class="insp-synopsis" style="height:150px" id="inspNotes" placeholder="Private notesâ€¦" oninput="onInspChange('notes', this.value)"></textarea>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• CORKBOARD VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="corkView">
    <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
      <div class="cork-toolbar">
        <span class="cork-toolbar-title">Corkboard</span>
        <button class="cork-filter active" onclick="filterCork('all',this)">All</button>
        <button class="cork-filter" onclick="filterCork('Act 1',this)">Act 1</button>
        <button class="cork-filter" onclick="filterCork('Act 2A',this)">Act 2A</button>
        <button class="cork-filter" onclick="filterCork('Act 2B',this)">Act 2B</button>
        <button class="cork-filter" onclick="filterCork('Act 3',this)">Act 3</button>
        <div class="cork-spacer"></div>
        <button class="cork-add" onclick="showNewSceneModal()">+ Add Card</button>
      </div>
      <div id="corkBoard"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• BEAT SHEET VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="beatView">
    <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
      <div class="beat-toolbar">
        <span class="beat-toolbar-title">Beat Sheet</span>
        <select class="beat-template-select" id="beatTemplateSelect" onchange="loadBeatTemplate()">
          <option value="savethecat">Save the Cat (Blake Snyder)</option>
          <option value="hero">Hero's Journey</option>
          <option value="threeact">Classic Three-Act</option>
          <option value="sequence">Eight-Sequence</option>
        </select>
      </div>
      <div id="beatBoard"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• CHARACTERS VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="charView">
    <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
      <div class="char-toolbar">
        <span class="char-toolbar-title">Character Profiles</span>
        <button class="cork-add" onclick="openCharModal(null)">+ New Character</button>
      </div>
      <div id="charGrid"></div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• LOGLINE / SYNOPSIS VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="loglineView">
    <div id="loglineArea">
      <div class="logline-section">
        <div class="logline-section-title">Logline</div>
        <textarea class="logline-input" id="loglineInput" rows="3" placeholder="When [inciting incident] happens to [protagonist], they must [objective] before [stakes/deadline]."></textarea>
        <div class="logline-hint">A great logline is one sentence. It names the protagonist, the central conflict, and the stakes. It should create a clear, visual image.</div>
      </div>
      <div class="logline-section">
        <div class="logline-section-title">One-Page Synopsis</div>
        <textarea class="logline-input large" id="synopsisInput" placeholder="Write a brief summary of your entire story â€” setup, confrontation, and resolutionâ€¦"></textarea>
      </div>
      <div class="logline-section">
        <div class="logline-section-title">Genre</div>
        <div class="genre-pills" id="genrePills">
          <button class="genre-pill" onclick="toggleGenre(this)">Action</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Adventure</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Animation</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Comedy</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Crime</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Documentary</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Drama</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Fantasy</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Horror</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Musical</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Mystery</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Romance</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Sci-Fi</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Thriller</button>
          <button class="genre-pill" onclick="toggleGenre(this)">Western</button>
        </div>
      </div>
      <div class="logline-section">
        <div class="logline-section-title">Central Themes</div>
        <textarea class="theme-textarea" id="themesInput" placeholder="What ideas or questions does your film explore? e.g. identity, revenge, redemption, familyâ€¦"></textarea>
      </div>
      <div class="logline-section">
        <div class="logline-section-title">Tone &amp; Visual Style</div>
        <textarea class="theme-textarea" id="toneInput" placeholder="Describe the look and feel. Comp films, visual inspirations, moodâ€¦"></textarea>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• RESEARCH VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="researchView">
    <div id="researchSidebar">
      <div class="research-list-header">
        <span class="research-list-title">Research</span>
        <button class="binder-add" onclick="addResearchEntry()" title="New entry">+</button>
      </div>
      <div id="researchList"></div>
    </div>
    <div id="researchMain">
      <div class="research-entry-header">
        <input id="researchTitleInput" type="text" placeholder="Entry titleâ€¦" oninput="onResearchTitleChange()" />
      </div>
      <textarea id="researchEditor" placeholder="Paste reference material, URLs, notes, historical context, technical details, location research, inspirationâ€¦&#10;&#10;Use this section to keep everything that informs your screenplay in one place." oninput="onResearchContentChange()"></textarea>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â• TIMELINE VIEW â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="timelineView">
    <div style="display:flex;flex-direction:column;flex:1;overflow:hidden">
      <div class="timeline-toolbar">
        <span class="timeline-toolbar-title">Scene Timeline â€” visual act structure</span>
      </div>
      <div id="timelineArea">
        <div class="timeline-acts" id="timelineActs"></div>
      </div>
    </div>
  </div>

</div><!-- /app -->

<!-- â•â•â•â•â•â•â•â•â•â• NEW SCENE MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="newSceneModal">
  <div class="modal-box">
    <div class="modal-header">
      <h2>New Document</h2>
      <button class="modal-close" onclick="closeModal('newSceneModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="modal-field full">
          <label class="modal-label">Title</label>
          <input class="modal-input" id="newDocTitle" placeholder="Scene or document titleâ€¦" />
        </div>
        <div class="modal-field">
          <label class="modal-label">Type</label>
          <select class="modal-input" id="newDocType">
            <option value="scene">Scene</option>
            <option value="sequence">Sequence</option>
            <option value="note">Note</option>
          </select>
        </div>
        <div class="modal-field">
          <label class="modal-label">Act</label>
          <select class="modal-input" id="newDocAct">
            <option value="Act 1">Act 1</option>
            <option value="Act 2A">Act 2A</option>
            <option value="Act 2B">Act 2B</option>
            <option value="Act 3">Act 3</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="modal-field full">
          <label class="modal-label">Synopsis (optional)</label>
          <textarea class="modal-input" style="height:70px;resize:none" id="newDocSynopsis" placeholder="Brief summaryâ€¦"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('newSceneModal')">Cancel</button>
      <button class="btn-save" onclick="createNewDoc()">Create</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• CHARACTER MODAL â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-bg" id="charModal">
  <div class="modal-box">
    <div class="modal-header">
      <h2 id="charModalTitle">New Character</h2>
      <button class="modal-close" onclick="closeModal('charModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-grid">
        <div class="modal-field full">
          <label class="modal-label">Full Name</label>
          <input class="modal-input" id="cName" placeholder="Character's full name" />
        </div>
        <div class="modal-field">
          <label class="modal-label">Role</label>
          <select class="modal-input" id="cRole">
            <option>Protagonist</option><option>Antagonist</option><option>Supporting</option>
            <option>Minor</option><option>Ensemble</option>
          </select>
        </div>
        <div class="modal-field">
          <label class="modal-label">Age</label>
          <input class="modal-input" id="cAge" placeholder="e.g. 34" />
        </div>
        <div class="modal-field">
          <label class="modal-label">Occupation</label>
          <input class="modal-input" id="cOccupation" placeholder="e.g. Detective" />
        </div>
        <div class="modal-field">
          <label class="modal-label">First Appears</label>
          <input class="modal-input" id="cFirstScene" placeholder="Scene title" />
        </div>
        <div class="modal-field full">
          <label class="modal-label">Physical Description</label>
          <textarea class="modal-textarea" id="cPhysical" placeholder="Appearance, mannerismsâ€¦"></textarea>
        </div>
        <div class="modal-field full">
          <label class="modal-label">Backstory / Biography</label>
          <textarea class="modal-textarea" id="cBackstory" placeholder="Key history that shapes this characterâ€¦"></textarea>
        </div>
        <div class="modal-field full">
          <label class="modal-label">Want vs Need</label>
          <input class="modal-input" id="cWant" placeholder="External want / internal needâ€¦" />
        </div>
        <div class="modal-field full">
          <label class="modal-label">Arc</label>
          <textarea class="modal-textarea" id="cArc" placeholder="How does this character change across the story?"></textarea>
        </div>
        <div class="modal-field full">
          <label class="modal-label">Key Relationships</label>
          <textarea class="modal-textarea" id="cRelationships" placeholder="How does this character relate to others?"></textarea>
        </div>
        <div class="modal-field full">
          <label class="modal-label">Notes</label>
          <textarea class="modal-textarea" id="cNotes" placeholder="Casting ideas, inspiration, other notesâ€¦"></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal('charModal')">Cancel</button>
      <button class="btn-save" id="charSaveBtn" onclick="saveCharacter()">Save Character</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast">Saved</div>

<!-- CONTEXT MENU -->
<div id="ctxMenu">
  <div class="ctx-item" id="ctxRename" onclick="ctxRename()">Rename</div>
  <div class="ctx-item" id="ctxDuplicate" onclick="ctxDuplicate()">Duplicate</div>
  <div class="ctx-item" id="ctxMoveAct" onclick="ctxMoveAct()">Move to Actâ€¦</div>
  <div class="ctx-item danger" id="ctxDelete" onclick="ctxDelete()">Delete</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  projectTitle: 'Untitled Project',
  docs: [],          // { id, title, type, act, content, synopsis, location, time, intExt, status, color, notes }
  characters: [],    // { id, name, role, age, occupation, physical, backstory, want, arc, relationships, notes, firstScene }
  research: [],      // { id, title, content }
  beats: {},         // { templateKey: [{name, pct, content, placeholder}] }
  logline: '',
  synopsis: '',
  genres: [],
  themes: '',
  tone: '',
  activeDocId: null,
  activeResearchId: null,
};

let editingCharId = null;
let ctxTargetId = null;
let autoSaveTimer = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  loadFromStorage();
  document.getElementById('projectTitleInput').value = state.projectTitle;
  document.getElementById('projectTitleInput').addEventListener('input', function() {
    state.projectTitle = this.value; scheduleSave();
  });
  renderBinder();
  renderCorkboard();
  renderCharacters();
  loadBeatTemplate();
  restoreLogline();
  renderResearch();
  renderTimeline();
  if (!state.activeDocId && state.docs.length > 0) openDoc(state.docs[0].id);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveAll() {
  localStorage.setItem('reel_state', JSON.stringify(state));
  showToast('Saved');
  document.getElementById('footerSaved').textContent = new Date().toLocaleTimeString();
}
function loadFromStorage() {
  const raw = localStorage.getItem('reel_state');
  if (raw) {
    try { Object.assign(state, JSON.parse(raw)); } catch(e) {}
  }
}
function scheduleSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(saveAll, 1500);
}
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (state.projectTitle || 'reel-project') + '.json';
  a.click();
  showToast('Exported');
}
function importData() {
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = '.json';
  inp.onchange = e => {
    const f = e.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        state = JSON.parse(ev.target.result);
        init();
        showToast('Imported');
      } catch(err) { alert('Invalid file'); }
    };
    r.readAsText(f);
  };
  inp.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEW SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(id, btn) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  btn.classList.add('active');
  if (id === 'corkView') renderCorkboard();
  if (id === 'charView') renderCharacters();
  if (id === 'timelineView') renderTimeline();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOCS / BINDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

function createNewDoc() {
  const title = document.getElementById('newDocTitle').value.trim() || 'Untitled';
  const type  = document.getElementById('newDocType').value;
  const act   = document.getElementById('newDocAct').value;
  const synopsis = document.getElementById('newDocSynopsis').value;
  const doc = { id: uid(), title, type, act, content:'', synopsis, location:'', time:'', intExt:'', status:'Draft', color:'#555', notes:'' };
  state.docs.push(doc);
  closeModal('newSceneModal');
  document.getElementById('newDocTitle').value = '';
  document.getElementById('newDocSynopsis').value = '';
  renderBinder();
  renderCorkboard();
  renderTimeline();
  openDoc(doc.id);
  scheduleSave();
}

function showNewSceneModal() {
  document.getElementById('newDocTitle').value = '';
  document.getElementById('newDocSynopsis').value = '';
  openModal('newSceneModal');
}

function openDoc(id) {
  state.activeDocId = id;
  const doc = state.docs.find(d => d.id === id);
  if (!doc) return;
  document.getElementById('docTitleInput').value = doc.title;
  document.getElementById('docEditor').value = doc.content;
  document.getElementById('inspSynopsis').value = doc.synopsis || '';
  document.getElementById('metaLocation').value = doc.location || '';
  document.getElementById('metaTime').value = doc.time || '';
  document.getElementById('metaIntExt').value = doc.intExt || '';
  document.getElementById('metaStatus').value = doc.status || 'Draft';
  document.getElementById('inspNotes').value = doc.notes || '';
  const badge = document.getElementById('docTypeBadge');
  badge.textContent = doc.type.toUpperCase();
  badge.className = 'doc-type-badge badge-' + (doc.type==='scene'?'scene':doc.type==='character'?'character':'note');
  updateColorChips(doc.color);
  updateFooter();
  // Mark active in binder
  document.querySelectorAll('.tree-item').forEach(el => {
    el.classList.toggle('active', el.dataset.id === id);
  });
  document.querySelectorAll('.tree-group-header').forEach(el => el.classList.remove('active-group'));
  // Switch to editor view
  if (!document.getElementById('editorView').classList.contains('active')) {
    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById('editorView').classList.add('active');
    document.querySelector('[data-view="editorView"]').classList.add('active');
  }
}

function onDocTitleChange() {
  const doc = state.docs.find(d => d.id === state.activeDocId);
  if (!doc) return;
  doc.title = document.getElementById('docTitleInput').value;
  refreshBinderItem(doc.id);
  renderCorkboard();
  renderTimeline();
  scheduleSave();
}
function onDocContentChange() {
  const doc = state.docs.find(d => d.id === state.activeDocId);
  if (!doc) return;
  doc.content = document.getElementById('docEditor').value;
  updateFooter();
  scheduleSave();
}
function onInspChange(field, val) {
  const doc = state.docs.find(d => d.id === state.activeDocId);
  if (!doc) return;
  doc[field] = val;
  if (field === 'synopsis') renderCorkboard();
  scheduleSave();
}
function setColor(c) {
  const doc = state.docs.find(d => d.id === state.activeDocId);
  if (!doc) return;
  doc.color = c;
  updateColorChips(c);
  renderBinder();
  renderCorkboard();
  renderTimeline();
  scheduleSave();
}
function updateColorChips(selected) {
  document.querySelectorAll('.color-chip').forEach(el => {
    el.classList.toggle('selected', el.dataset.color === selected);
  });
}
function updateFooter() {
  const val = document.getElementById('docEditor').value;
  const words = val.trim() ? val.trim().split(/\s+/).length : 0;
  document.getElementById('footerWords').textContent = words;
  document.getElementById('footerChars').textContent = val.length;
}

// â”€â”€â”€ BINDER RENDER â”€â”€â”€
const ACT_ORDER = ['Act 1','Act 2A','Act 2B','Act 3','Other'];
function renderBinder() {
  const tree = document.getElementById('binderTree');
  const groups = {};
  ACT_ORDER.forEach(a => { groups[a] = []; });
  state.docs.forEach(d => {
    if (!groups[d.act]) groups[d.act] = [];
    groups[d.act].push(d);
  });
  tree.innerHTML = '';
  ACT_ORDER.forEach(act => {
    const docs = groups[act];
    if (!docs) return;
    const group = document.createElement('div');
    group.className = 'tree-group';
    const open = true;
    group.innerHTML = `
      <div class="tree-group-header" data-act="${act}" onclick="toggleAct(this)">
        <span class="tree-chevron open">â–¶</span>
        <span class="tree-group-icon">${actIcon(act)}</span>
        <span class="tree-group-label">${act}</span>
        <span class="tree-badge" style="font-size:9px;color:var(--text3)">${docs.length}</span>
      </div>
      <div class="tree-children open" id="act_${act.replace(/\s/g,'_')}">
        ${docs.map(d => `
          <div class="tree-item ${d.id===state.activeDocId?'active':''}" data-id="${d.id}"
               onclick="openDoc('${d.id}')" oncontextmenu="showCtx(event,'${d.id}')">
            <span class="tree-item-icon" style="color:${d.color}">${docIcon(d.type)}</span>
            <span class="tree-item-label">${d.title||'Untitled'}</span>
            <button class="tree-del" onclick="event.stopPropagation();deleteDoc('${d.id}')">âœ•</button>
          </div>`).join('')}
      </div>`;
    tree.appendChild(group);
  });
}

function refreshBinderItem(id) {
  const el = document.querySelector(`.tree-item[data-id="${id}"] .tree-item-label`);
  if (el) el.textContent = state.docs.find(d => d.id === id)?.title || 'Untitled';
}

function toggleAct(header) {
  const ch = header.querySelector('.tree-chevron');
  const children = header.nextElementSibling;
  const isOpen = children.classList.contains('open');
  children.classList.toggle('open', !isOpen);
  ch.classList.toggle('open', !isOpen);
}

function actIcon(act) {
  const map = {'Act 1':'â‘ ','Act 2A':'â‘¡','Act 2B':'â‘¢','Act 3':'â‘£','Other':'â—†'};
  return map[act] || 'â—†';
}
function docIcon(type) {
  const map = {scene:'ğŸ¬', sequence:'ğŸ“', note:'ğŸ“', character:'ğŸ‘¤'};
  return map[type] || 'ğŸ“„';
}
function deleteDoc(id) {
  if (!confirm('Delete this document?')) return;
  state.docs = state.docs.filter(d => d.id !== id);
  if (state.activeDocId === id) {
    state.activeDocId = null;
    document.getElementById('docEditor').value = '';
    document.getElementById('docTitleInput').value = '';
  }
  renderBinder(); renderCorkboard(); renderTimeline(); scheduleSave();
}

// â”€â”€â”€ CONTEXT MENU â”€â”€â”€
function showCtx(e, id) {
  e.preventDefault();
  ctxTargetId = id;
  const m = document.getElementById('ctxMenu');
  m.style.display = 'block';
  m.style.left = e.clientX + 'px';
  m.style.top  = e.clientY + 'px';
}
document.addEventListener('click', () => { document.getElementById('ctxMenu').style.display='none'; });
function ctxRename() {
  const doc = state.docs.find(d=>d.id===ctxTargetId); if(!doc)return;
  const n = prompt('Rename:', doc.title); if(!n) return;
  doc.title = n; renderBinder(); renderCorkboard(); renderTimeline(); scheduleSave();
}
function ctxDuplicate() {
  const doc = state.docs.find(d=>d.id===ctxTargetId); if(!doc)return;
  const copy = {...doc, id:uid(), title: doc.title + ' (copy)'};
  state.docs.push(copy); renderBinder(); renderCorkboard(); renderTimeline(); scheduleSave();
}
function ctxMoveAct() {
  const acts = ACT_ORDER.join('\n');
  const choice = prompt('Move to act:\n' + acts);
  if (!choice || !ACT_ORDER.includes(choice)) return;
  const doc = state.docs.find(d=>d.id===ctxTargetId); if(!doc)return;
  doc.act = choice; renderBinder(); renderCorkboard(); renderTimeline(); scheduleSave();
}
function ctxDelete() { deleteDoc(ctxTargetId); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CORKBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let corkFilter = 'all';
function filterCork(act, btn) {
  corkFilter = act;
  document.querySelectorAll('.cork-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderCorkboard();
}
function renderCorkboard() {
  const board = document.getElementById('corkBoard');
  const docs = corkFilter === 'all' ? state.docs : state.docs.filter(d=>d.act===corkFilter);
  if (!docs.length) {
    board.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“Œ</div><div class="empty-title">No Cards</div><div class="empty-sub">Create scenes in the Binder to see them here as index cards.</div></div>';
    return;
  }
  board.innerHTML = docs.map((d,i) => `
    <div class="index-card" onclick="openDoc('${d.id}')">
      <div class="card-stripe" style="background:${d.color||'#555'}"></div>
      <div class="card-body">
        <div class="card-number">${d.act} Â· ${String(i+1).padStart(2,'0')}</div>
        <div class="card-title">${d.title||'Untitled'}</div>
        <div class="card-synopsis">${d.synopsis || '<span style="color:#bbb;font-style:italic">No synopsis yet</span>'}</div>
      </div>
      <div class="card-footer">
        <span class="card-tag">${d.type}</span>
        <span class="card-words">${wordCount(d.content)}w</span>
      </div>
      <button class="card-del" onclick="event.stopPropagation();deleteDoc('${d.id}')">âœ•</button>
    </div>`).join('');
}
function wordCount(txt) {
  return txt.trim() ? txt.trim().split(/\s+/).length : 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BEAT SHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BEAT_TEMPLATES = {
  savethecat: [
    {name:'Opening Image',pct:'1%',placeholder:'A single scene that sets the tone, mood, type, and scope. The "before" snapshot.'},
    {name:'Theme Stated',pct:'5%',placeholder:'A character (not the hero) states what the film is about â€” the thematic premise.'},
    {name:'Set-Up',pct:'1â€“10%',placeholder:'Introduce the hero in their ordinary world. Plant all the seeds that Act 3 will harvest.'},
    {name:'Catalyst',pct:'10%',placeholder:'The life-changing event that kicks the story into motion. Nothing will ever be the same.'},
    {name:"Debate",pct:'10â€“20%',placeholder:'The hero resists the call. A question is posed that the rest of the film will answer.'},
    {name:'Break Into Two',pct:'20%',placeholder:'The hero makes an active choice to enter the upside-down world of Act 2.'},
    {name:'B Story',pct:'22%',placeholder:'The love story or the relationship that carries the theme. Often the mentor/sidekick.'},
    {name:'Fun & Games',pct:'20â€“50%',placeholder:"The promise of the premise. This is why audiences buy a ticket. Deliver it."},
    {name:'Midpoint',pct:'50%',placeholder:'False peak or false collapse. Stakes are raised. Hero goes from wanting to needing.'},
    {name:'Bad Guys Close In',pct:'50â€“75%',placeholder:'External pressure mounts. Internal doubts increase. The team begins to fracture.'},
    {name:'All Is Lost',pct:'75%',placeholder:'The worst thing that can happen. The whiff of death. The old world is completely gone.'},
    {name:'Dark Night of the Soul',pct:'75â€“80%',placeholder:'The hero digs deep to find the answer. Often a catalyst from the B Story appears.'},
    {name:'Break Into Three',pct:'80%',placeholder:'The hero discovers the solution to the problem â€” armed with new information.'},
    {name:'Finale',pct:'80â€“99%',placeholder:'Execute the plan. Prove the theme. Dig down and fight. The old world is left behind.'},
    {name:'Final Image',pct:'99%',placeholder:'The mirror of the opening image. Show how much has changed.'},
  ],
  hero: [
    {name:'Ordinary World',pct:'Opening',placeholder:"The hero's normal world before the adventure begins."},
    {name:'Call to Adventure',pct:'~10%',placeholder:'The hero is presented with a problem, challenge, or adventure.'},
    {name:'Refusal of the Call',pct:'~12%',placeholder:'The hero initially refuses or is reluctant to face the challenge.'},
    {name:'Meeting the Mentor',pct:'~15%',placeholder:'The hero meets a mentor figure who gives advice, gifts, or guidance.'},
    {name:'Crossing the Threshold',pct:'~20%',placeholder:'The hero commits to the adventure and leaves the ordinary world.'},
    {name:'Tests, Allies, Enemies',pct:'20â€“50%',placeholder:'The hero faces tests, meets allies, and confronts enemies.'},
    {name:'Approach the Inmost Cave',pct:'~50%',placeholder:'The hero approaches the central crisis or ordeal.'},
    {name:'Ordeal',pct:'~60%',placeholder:'The hero faces a major challenge â€” the crisis or moment of death and rebirth.'},
    {name:'Reward',pct:'~65%',placeholder:'The hero seizes the sword or reward after surviving the ordeal.'},
    {name:'The Road Back',pct:'~75%',placeholder:'The hero commits to returning home, pursued by the antagonistic force.'},
    {name:'Resurrection',pct:'~90%',placeholder:'The climax. The hero faces a final test and is transformed.'},
    {name:'Return with Elixir',pct:'End',placeholder:'The hero returns home changed, bringing something of value to the world.'},
  ],
  threeact: [
    {name:'Act 1: Setup',pct:'1â€“25%',placeholder:'Establish protagonist, world, and the central dramatic question.'},
    {name:'Inciting Incident',pct:'~10%',placeholder:'The event that sets the story in motion.'},
    {name:'Plot Point 1',pct:'~25%',placeholder:'The turn that launches the hero into Act 2.'},
    {name:'Act 2A: Rising Action',pct:'25â€“50%',placeholder:'Protagonist pursues goal. Obstacles and complications mount.'},
    {name:'Midpoint',pct:'50%',placeholder:'Major reversal, revelation, or shift in the story.'},
    {name:'Act 2B: Complications',pct:'50â€“75%',placeholder:'Stakes increase. Hero pushed to the limit. Darkest moment approaches.'},
    {name:'Plot Point 2',pct:'~75%',placeholder:'Everything falls apart. The hero must find new resolve.'},
    {name:'Act 3: Resolution',pct:'75â€“100%',placeholder:'Final confrontation and resolution. Themes are paid off.'},
    {name:'Climax',pct:'~90%',placeholder:'The ultimate confrontation between protagonist and antagonist.'},
    {name:'Denouement',pct:'End',placeholder:'The aftermath. New equilibrium is established.'},
  ],
  sequence: [
    {name:'Sequence 1: Status Quo',pct:'0â€“12%',placeholder:'Establish world. Plant a problem or desire in motion.'},
    {name:'Sequence 2: Predicament',pct:'12â€“25%',placeholder:'The hero faces a new predicament or situation.'},
    {name:'Sequence 3: First Obstacle',pct:'25â€“37%',placeholder:'The central goal is established. First major obstacle appears.'},
    {name:'Sequence 4: First Culmination',pct:'37â€“50%',placeholder:'Partial resolution of Act 2A. False sense of progress.'},
    {name:'Sequence 5: Subplot',pct:'50â€“62%',placeholder:'Subplots complicate the main storyline. New complications.'},
    {name:'Sequence 6: Main Culmination',pct:'62â€“75%',placeholder:'Main story reaches its darkest point. All seems lost.'},
    {name:'Sequence 7: New Tension',pct:'75â€“88%',placeholder:'New drive toward resolution. Climax is set up.'},
    {name:'Sequence 8: Resolution',pct:'88â€“100%',placeholder:'Climax and aftermath. All story threads resolved.'},
  ],
};

function loadBeatTemplate() {
  const key = document.getElementById('beatTemplateSelect').value;
  const template = BEAT_TEMPLATES[key];
  if (!state.beats[key]) {
    state.beats[key] = template.map(b => ({...b, content:''}));
  }
  renderBeatBoard(key);
}
function renderBeatBoard(key) {
  const beats = state.beats[key];
  const colors = ['#c9a84c','#c44a3a','#4a7fa8','#5a9a6a','#8a5a9a','#9a7a5a','#4a8a8a'];
  const board = document.getElementById('beatBoard');
  board.innerHTML = `<div class="beat-structure">${beats.map((b,i) => `
    <div class="beat-item" style="border-left-color:${colors[i%colors.length]}">
      <div class="beat-left">
        <div class="beat-name">${b.name}</div>
        <div class="beat-pct">${b.pct}</div>
      </div>
      <div class="beat-right">
        <textarea class="beat-textarea" data-key="${key}" data-idx="${i}" 
          placeholder="${b.placeholder}"
          oninput="onBeatChange('${key}',${i},this.value)">${b.content||''}</textarea>
      </div>
    </div>`).join('')}</div>`;
}
function onBeatChange(key, idx, val) {
  state.beats[key][idx].content = val;
  scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHARACTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCharacters() {
  const grid = document.getElementById('charGrid');
  if (!state.characters.length) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ‘¤</div><div class="empty-title">No Characters Yet</div><div class="empty-sub">Add characters to build detailed profiles for your screenplay.</div></div>';
    return;
  }
  grid.innerHTML = state.characters.map(c => `
    <div class="char-card" onclick="openCharModal('${c.id}')">
      <div class="char-card-head">
        <div class="char-initial">${(c.name||'?')[0].toUpperCase()}</div>
        <div class="char-card-name">${c.name||'Unnamed'}</div>
        <div class="char-role-badge">${c.role||''} ${c.age ? 'Â· '+c.age : ''}</div>
        <button class="char-card-del" onclick="event.stopPropagation();deleteChar('${c.id}')">Delete</button>
      </div>
      <div class="char-card-body">
        ${c.occupation ? `<div class="char-field"><div class="char-field-label">Occupation</div><div class="char-field-val">${c.occupation}</div></div>` : ''}
        ${c.want ? `<div class="char-field"><div class="char-field-label">Want / Need</div><div class="char-field-val">${c.want}</div></div>` : ''}
        ${c.arc ? `<div class="char-field"><div class="char-field-label">Arc</div><div class="char-field-val">${c.arc.substring(0,100)}${c.arc.length>100?'â€¦':''}</div></div>` : ''}
      </div>
    </div>`).join('');
}
function openCharModal(id) {
  editingCharId = id;
  const c = id ? state.characters.find(ch=>ch.id===id) : null;
  document.getElementById('charModalTitle').textContent = c ? 'Edit Character' : 'New Character';
  document.getElementById('cName').value = c?.name||'';
  document.getElementById('cRole').value = c?.role||'Protagonist';
  document.getElementById('cAge').value = c?.age||'';
  document.getElementById('cOccupation').value = c?.occupation||'';
  document.getElementById('cFirstScene').value = c?.firstScene||'';
  document.getElementById('cPhysical').value = c?.physical||'';
  document.getElementById('cBackstory').value = c?.backstory||'';
  document.getElementById('cWant').value = c?.want||'';
  document.getElementById('cArc').value = c?.arc||'';
  document.getElementById('cRelationships').value = c?.relationships||'';
  document.getElementById('cNotes').value = c?.notes||'';
  openModal('charModal');
}
function saveCharacter() {
  const data = {
    name: document.getElementById('cName').value.trim(),
    role: document.getElementById('cRole').value,
    age: document.getElementById('cAge').value,
    occupation: document.getElementById('cOccupation').value,
    firstScene: document.getElementById('cFirstScene').value,
    physical: document.getElementById('cPhysical').value,
    backstory: document.getElementById('cBackstory').value,
    want: document.getElementById('cWant').value,
    arc: document.getElementById('cArc').value,
    relationships: document.getElementById('cRelationships').value,
    notes: document.getElementById('cNotes').value,
  };
  if (!data.name) { alert('Please enter a name.'); return; }
  if (editingCharId) {
    const c = state.characters.find(ch=>ch.id===editingCharId);
    Object.assign(c, data);
  } else {
    state.characters.push({id:uid(), ...data});
  }
  closeModal('charModal');
  renderCharacters();
  scheduleSave();
}
function deleteChar(id) {
  if (!confirm('Delete this character?')) return;
  state.characters = state.characters.filter(c=>c.id!==id);
  renderCharacters(); scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOGLINE / SYNOPSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function restoreLogline() {
  document.getElementById('loglineInput').value = state.logline || '';
  document.getElementById('synopsisInput').value = state.synopsis || '';
  document.getElementById('themesInput').value = state.themes || '';
  document.getElementById('toneInput').value = state.tone || '';
  document.querySelectorAll('.genre-pill').forEach(p => {
    p.classList.toggle('selected', (state.genres||[]).includes(p.textContent));
  });
  document.getElementById('loglineInput').addEventListener('input', function() { state.logline = this.value; scheduleSave(); });
  document.getElementById('synopsisInput').addEventListener('input', function() { state.synopsis = this.value; scheduleSave(); });
  document.getElementById('themesInput').addEventListener('input', function() { state.themes = this.value; scheduleSave(); });
  document.getElementById('toneInput').addEventListener('input', function() { state.tone = this.value; scheduleSave(); });
}
function toggleGenre(btn) {
  btn.classList.toggle('selected');
  state.genres = [...document.querySelectorAll('.genre-pill.selected')].map(p=>p.textContent);
  scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addResearchEntry() {
  const entry = { id: uid(), title: 'New Entry', content: '' };
  state.research.push(entry);
  renderResearch();
  openResearch(entry.id);
  scheduleSave();
}
function renderResearch() {
  const list = document.getElementById('researchList');
  if (!state.research.length) {
    list.innerHTML = '<div style="padding:10px 12px;font-size:11px;color:var(--text3)">No entries yet</div>';
    return;
  }
  list.innerHTML = state.research.map(e => `
    <div class="research-item ${e.id===state.activeResearchId?'active':''}" onclick="openResearch('${e.id}')">
      <span class="research-item-icon">ğŸ“„</span>
      <span class="research-item-name">${e.title||'Untitled'}</span>
      <button class="research-item-del" onclick="event.stopPropagation();deleteResearch('${e.id}')">âœ•</button>
    </div>`).join('');
}
function openResearch(id) {
  state.activeResearchId = id;
  const e = state.research.find(r=>r.id===id);
  if (!e) return;
  document.getElementById('researchTitleInput').value = e.title;
  document.getElementById('researchEditor').value = e.content;
  renderResearch();
}
function onResearchTitleChange() {
  const e = state.research.find(r=>r.id===state.activeResearchId);
  if (!e) return;
  e.title = document.getElementById('researchTitleInput').value;
  renderResearch();
  scheduleSave();
}
function onResearchContentChange() {
  const e = state.research.find(r=>r.id===state.activeResearchId);
  if (!e) return;
  e.content = document.getElementById('researchEditor').value;
  scheduleSave();
}
function deleteResearch(id) {
  if (!confirm('Delete this entry?')) return;
  state.research = state.research.filter(r=>r.id!==id);
  if (state.activeResearchId === id) {
    state.activeResearchId = null;
    document.getElementById('researchTitleInput').value = '';
    document.getElementById('researchEditor').value = '';
  }
  renderResearch(); scheduleSave();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTimeline() {
  const container = document.getElementById('timelineActs');
  const actColors = {'Act 1':'#c9a84c','Act 2A':'#c44a3a','Act 2B':'#4a7fa8','Act 3':'#5a9a6a','Other':'#888'};
  container.innerHTML = ACT_ORDER.map(act => {
    const docs = state.docs.filter(d=>d.act===act);
    return `
      <div class="timeline-act">
        <div class="act-header" style="border-color:${actColors[act]};color:${actColors[act]}">${act}</div>
        <div class="act-scenes">
          ${docs.length ? docs.map(d=>`
            <div class="tl-scene" style="border-left-color:${d.color||actColors[act]}" onclick="openDoc('${d.id}')">
              <div class="tl-scene-title">${d.title||'Untitled'}</div>
              <div class="tl-scene-loc">${d.intExt?d.intExt+' ':''}${d.location||''} ${d.time||''}</div>
            </div>`).join('')
          : '<div style="font-size:11px;color:var(--text3);padding:6px">No scenes</div>'}
        </div>
      </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-bg').forEach(m => {
  m.addEventListener('click', e => { if(e.target===m) m.classList.remove('open'); });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 2000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', e => {
  if ((e.metaKey||e.ctrlKey) && e.key==='s') { e.preventDefault(); saveAll(); }
  if ((e.metaKey||e.ctrlKey) && e.key==='n') { e.preventDefault(); showNewSceneModal(); }
});

// â”€â”€â”€ START â”€â”€â”€
init();
</script>
</body>
</html>
